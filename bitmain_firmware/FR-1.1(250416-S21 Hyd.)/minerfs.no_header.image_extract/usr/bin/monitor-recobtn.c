/* This file was generated by the Hex-Rays decompiler version 9.2.0.250908.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

int init_proc();
void sub_10590();
// int printf(const char *format, ...);
// int _isoc99_fscanf(_DWORD, const char *, ...); weak
// int execvp(const char *file, char *const argv[]);
// unsigned int sleep(unsigned int seconds);
// __pid_t wait(void *stat_loc);
// size_t fwrite(const void *ptr, size_t size, size_t n, FILE *s);
// int usleep(__useconds_t useconds);
// int gettimeofday(struct timeval *tv, __timezone_ptr_t tz);
// int puts(const char *s);
// int _libc_start_main(int (*main)(int, char **, char **), int argc, char **ubp_av, void (*init)(), void (*fini)(), void (*rtld_fini)(), void *stack_end);
// int system(const char *command);
// int _gmon_start__(void); weak
// void exit(int status);
// size_t strlen(const char *s);
// void *memset(void *s, int c, size_t n);
// int access(const char *name, int type);
// int fclose(FILE *stream);
// __pid_t fork(void);
// int sprintf(char *s, const char *format, ...);
// int __fastcall fopen64(_DWORD, _DWORD); weak
// void abort(void);
void __noreturn start(void (*a1)(), int a2, int a3, int a4, ...);
int sub_108B0();
char *sub_108D4();
__int64 sub_108F8();
char *sub_10924();
int __fastcall sub_10940(int a1);
bool __fastcall sub_109A8(const char *a1);
int sub_109C0();
int __fastcall init(int a1, int a2, int a3);
int nullsub_1(); // weak
void term_proc();

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN main;
_UNKNOWN *off_20F10 = (_UNKNOWN *)0x1093D; // weak
_UNKNOWN *off_20F14 = (_UNKNOWN *)0x10925; // weak
char byte_2106C; // weak
// extern _UNKNOWN __gmon_start__; weak


//----- (00010584) --------------------------------------------------------
int init_proc()
{
  return sub_108B0();
}

//----- (00010590) --------------------------------------------------------
void sub_10590()
{
  JUMPOUT(0);
}
// 1059C: control flows out of bounds to 0

//----- (000106A0) --------------------------------------------------------
void __fastcall __noreturn main(int a1, char **a2, char **a3)
{
  struct timezone *v5; // r1
  __pid_t v6; // r0
  int v7; // r4
  struct timeval v8; // [sp+0h] [bp-14h] BYREF
  struct timeval tv; // [sp+8h] [bp-Ch] BYREF

  printf("monitor-recobtn compile %s--%s\n", "Apr 16 2025", "10:22:22");
  while ( 1 )
  {
    v5 = (struct timezone *)sub_109C0();
    if ( v5 )
      goto LABEL_15;
    do
    {
      gettimeofday(&v8, v5);
      sub_10940(1);
      puts("Detect recovery button push off");
      while ( sub_109C0() != 1 )
      {
LABEL_5:
        gettimeofday(&tv, 0);
        if ( tv.tv_usec + 1000000 * (tv.tv_sec - v8.tv_sec) - v8.tv_usec <= 3000000 )
        {
          usleep(0x7A120u);
        }
        else
        {
          puts("recovery button off over 3S, wait push on");
          while ( !sub_109C0() )
          {
            sub_10940(1);
            sleep(1u);
            sub_10940(0);
            sleep(1u);
          }
          puts("recovery button on");
          v6 = fork();
          if ( v6 >= 0 )
          {
            if ( !v6 )
            {
              sub_10940(0);
              if ( a1 <= 1 )
                sleep(1u);
              else
                execvp(a2[1], a2 + 1);
              exit(0);
            }
            wait(0);
            v7 = 100;
            puts("child complete");
            do
            {
              sub_10940(1);
              usleep(0x186A0u);
              sub_10940(0);
              usleep(0x186A0u);
              --v7;
            }
            while ( v7 );
            puts("recovery factory complete");
            if ( sub_109C0() == 1 )
              break;
            goto LABEL_5;
          }
          puts("error occured.");
        }
      }
      sub_10940(0);
      v5 = (struct timezone *)sub_109C0();
    }
    while ( !v5 );
LABEL_15:
    sleep(1u);
  }
}

//----- (00010880) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __noreturn start(void (*a1)(), int a2, int a3, int a4, ...)
{
  int v4; // [sp-4h] [bp-4h]
  va_list va; // [sp+0h] [bp+0h] BYREF

  va_start(va, a4);
  _libc_start_main(
    (int (*)(int, char **, char **))main,
    v4,
    (char **)va,
    (void (*)())init,
    (void (*)())nullsub_1,
    a1,
    va);
  abort();
}
// 1088A: positive sp value 4 has been found
// 1089C: variable 'v4' is possibly undefined
// 10AF8: using guessed type int init();
// 10B34: using guessed type int nullsub_1();

//----- (000108B0) --------------------------------------------------------
int sub_108B0()
{
  int result; // r0

  if ( &__gmon_start__ )
    return _gmon_start__();
  return result;
}
// 10628: using guessed type int _gmon_start__(void);

//----- (000108D4) --------------------------------------------------------
char *sub_108D4()
{
  return &byte_2106C;
}
// 2106C: using guessed type char byte_2106C;

//----- (000108F8) --------------------------------------------------------
__int64 sub_108F8()
{
  __int64 result; // r0

  LODWORD(result) = &byte_2106C;
  HIDWORD(result) = 0;
  return result;
}
// 2106C: using guessed type char byte_2106C;

//----- (00010924) --------------------------------------------------------
char *sub_10924()
{
  char *result; // r0

  if ( !byte_2106C )
  {
    result = sub_108D4();
    byte_2106C = 1;
  }
  return result;
}
// 2106C: using guessed type char byte_2106C;

//----- (00010940) --------------------------------------------------------
int __fastcall sub_10940(int a1)
{
  int v1; // r5
  const char *v2; // r4
  char v4[68]; // [sp+0h] [bp-44h] BYREF

  v1 = a1;
  LOWORD(v2) = (unsigned __int16)"echo %d > /sys/class/gpio/gpio%d/value";
  if ( a1 )
    v1 = 1;
  HIWORD(v2) = (unsigned int)"echo %d > /sys/class/gpio/gpio%d/value" >> 16;
  memset(v4, 0, 0x40u);
  sprintf(v4, v2, v1, 941);
  system(v4);
  sprintf(v4, v2, v1, 942);
  return system(v4);
}

//----- (000109A8) --------------------------------------------------------
bool __fastcall sub_109A8(const char *a1)
{
  return access(a1, 0) == 0;
}

//----- (000109C0) --------------------------------------------------------
int sub_109C0()
{
  FILE *v0; // r4
  size_t v1; // r0
  int result; // r0
  int v3; // r0
  FILE *v4; // r4
  int v5; // [sp+4h] [bp-44h] BYREF
  char s[64]; // [sp+8h] [bp-40h] BYREF

  memset(s, 0, sizeof(s));
  sprintf(s, "/sys/class/gpio/gpio%d", 921);
  if ( access(s, 0) )
  {
    v0 = (FILE *)fopen64("/sys/class/gpio/export", "w");
    if ( v0 )
    {
      sprintf(s, "%d", 921);
      v1 = strlen(s);
      if ( fwrite(s, v1, 1u, v0) != 1 )
        puts("File Write Error!");
      fclose(v0);
      return -1;
    }
    else
    {
      puts("Open read gpio/export");
      return -1;
    }
  }
  else
  {
    sprintf(s, "/sys/class/gpio/gpio%d/value", 921);
    v3 = fopen64(s, "r");
    v4 = (FILE *)v3;
    if ( v3 )
    {
      _isoc99_fscanf(v3, "%d", &v5);
      fclose(v4);
      result = v5;
      if ( v5 )
        return 1;
    }
    else
    {
      puts("Open read recovery button failure");
      return -1;
    }
  }
  return result;
}
// 105B0: using guessed type int _isoc99_fscanf(_DWORD, const char *, ...);
// 10688: using guessed type int __fastcall fopen64(_DWORD, _DWORD);

//----- (00010AF8) --------------------------------------------------------
int __fastcall init(int a1, int a2, int a3)
{
  int result; // r0
  int (__fastcall **v7)(int, int, int); // r5
  int v8; // r6
  int i; // r4
  int (__fastcall *v10)(int, int, int); // t1

  result = init_proc();
  v7 = (int (__fastcall **)(int, int, int))&off_20F10;
  v8 = &off_20F14 - &off_20F10;
  if ( v8 )
  {
    for ( i = 0; i != v8; ++i )
    {
      v10 = *v7++;
      result = v10(a1, a2, a3);
    }
  }
  return result;
}
// 20F10: using guessed type _UNKNOWN *off_20F10;
// 20F14: using guessed type _UNKNOWN *off_20F14;

//----- (00010B38) --------------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=57 queued=13 decompiled=13 lumina nreq=0 worse=0 better=0
// ALL OK, 13 function(s) have been successfully decompiled
