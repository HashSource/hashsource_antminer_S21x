/* This file was generated by the Hex-Rays decompiler version 9.2.0.250908.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>

#include <stdarg.h>


//-------------------------------------------------------------------------
// Function declarations

int init_proc();
void sub_107A0();
// void *calloc(size_t nmemb, size_t size);
// int setsockopt(int fd, int level, int optname, const void *optval, socklen_t optlen);
// int printf(const char *format, ...);
// int _isoc99_fscanf(_DWORD, const char *, ...); weak
// void free(void *ptr);
// void *memcpy(void *dest, const void *src, size_t n);
// char *inet_ntoa(struct in_addr in);
// int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
// int __fastcall stpcpy(_DWORD, _DWORD); weak
// ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len);
// void perror(const char *s);
// size_t fwrite(const void *ptr, size_t size, size_t n, FILE *s);
// int ioctl(int fd, unsigned int request, ...);
// int usleep(__useconds_t useconds);
// char *strcpy(char *dest, const char *src);
// int puts(const char *s);
// int _libc_start_main(int (*main)(int, char **, char **), int argc, char **ubp_av, void (*init)(), void (*fini)(), void (*rtld_fini)(), void *stack_end);
// int system(const char *command);
// int _gmon_start__(void); weak
// void exit(int status);
// size_t strlen(const char *s);
// int bind(int fd, const struct sockaddr *addr, socklen_t len);
// void *memset(void *s, int c, size_t n);
// char *strncpy(char *dest, const char *src, size_t n);
// int access(const char *name, int type);
// int fclose(FILE *stream);
// ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len);
// int sprintf(char *s, const char *format, ...);
// int __fastcall fopen64(_DWORD, _DWORD); weak
// int socket(int domain, int type, int protocol);
// int strncmp(const char *s1, const char *s2, size_t n);
// void abort(void);
// int close(int fd);
void __noreturn start(void (*a1)(), int a2, int a3, int a4, ...);
int sub_109F8();
char *sub_10A1C();
__int64 sub_10A40();
char *sub_10A6C();
int __fastcall sub_10AFC(const char *a1, char *a2);
_DWORD *__fastcall sub_10BBC(_DWORD *a1, const char *a2);
char *__fastcall sub_10CC0(char *a1, const char *a2);
int __fastcall sub_10DA0(int a1);
bool __fastcall sub_10E04(const char *a1);
int sub_10E1C();
int __fastcall sub_10F58(int a1);
int sub_10FE8();
int sub_110EC();
int __fastcall sub_1121C(void *buf); // idb
int sub_11274();
int sub_114A8();
int __fastcall init(int a1, int a2, int a3);
int nullsub_1(); // weak
void term_proc();

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN main;
_UNKNOWN *off_21F10 = (_UNKNOWN *)0x10A85; // weak
_UNKNOWN *off_21F14 = (_UNKNOWN *)0x10A6D; // weak
int dword_220A4 = -1; // weak
char byte_220A8; // weak
char byte_220AC[32]; // weak
int dword_220CC; // weak
int dword_220D4; // weak
int dword_220D8; // weak
int dword_220DC; // weak
int dword_220E0; // weak
int dword_220E4; // weak
int dword_220E8; // weak
int dword_220EC; // weak
int dword_220F0; // weak
// extern _UNKNOWN __gmon_start__; weak


//----- (00010794) --------------------------------------------------------
int init_proc()
{
  return sub_109F8();
}

//----- (000107A0) --------------------------------------------------------
void sub_107A0()
{
  JUMPOUT(0);
}
// 107AC: control flows out of bounds to 0

//----- (00010958) --------------------------------------------------------
void __fastcall __noreturn main(int a1, char **a2, char **a3)
{
  printf("monitor-ipsig compile %s--%s\n", "Apr 16 2025", "10:22:21");
  sub_10FE8();
  while ( 1 )
  {
    while ( sub_114A8() != 1 )
      usleep(0x61A80u);
    do
    {
      puts("Key Down!!!!!");
      sub_110EC();
    }
    while ( sub_11274() != 1 );
  }
}

//----- (000109C8) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __noreturn start(void (*a1)(), int a2, int a3, int a4, ...)
{
  int v4; // [sp-4h] [bp-4h]
  va_list va; // [sp+0h] [bp+0h] BYREF

  va_start(va, a4);
  _libc_start_main(
    (int (*)(int, char **, char **))main,
    v4,
    (char **)va,
    (void (*)())init,
    (void (*)())nullsub_1,
    a1,
    va);
  abort();
}
// 109D2: positive sp value 4 has been found
// 109E4: variable 'v4' is possibly undefined
// 1153C: using guessed type int init();
// 11578: using guessed type int nullsub_1();

//----- (000109F8) --------------------------------------------------------
int sub_109F8()
{
  int result; // r0

  if ( &__gmon_start__ )
    return _gmon_start__();
  return result;
}
// 108A4: using guessed type int _gmon_start__(void);

//----- (00010A1C) --------------------------------------------------------
char *sub_10A1C()
{
  return &byte_220A8;
}
// 220A8: using guessed type char byte_220A8;

//----- (00010A40) --------------------------------------------------------
__int64 sub_10A40()
{
  __int64 result; // r0

  LODWORD(result) = &byte_220A8;
  HIDWORD(result) = 0;
  return result;
}
// 220A8: using guessed type char byte_220A8;

//----- (00010A6C) --------------------------------------------------------
char *sub_10A6C()
{
  char *result; // r0

  if ( !byte_220A8 )
  {
    result = sub_10A1C();
    byte_220A8 = 1;
  }
  return result;
}
// 220A8: using guessed type char byte_220A8;

//----- (00010AFC) --------------------------------------------------------
int __fastcall sub_10AFC(const char *a1, char *a2)
{
  int v4; // r4
  char *v5; // r0
  int v6; // r0
  char dest[20]; // [sp+10h] [bp-20h] BYREF
  struct in_addr v9; // [sp+24h] [bp-Ch]

  v4 = socket(2, 2, 0);
  if ( v4 == -1 )
  {
    perror("socket");
  }
  else
  {
    strncpy(dest, a1, 0x14u);
    dest[15] = 48;
    if ( ioctl(v4, 0x8915u, dest) < 0 )
    {
      v4 = -1;
      printf(":No Such Device %s/n", a1);
    }
    else
    {
      v5 = inet_ntoa(v9);
      strcpy(a2, v5);
      v6 = v4;
      v4 = 1;
      close(v6);
    }
  }
  return v4;
}

//----- (00010BBC) --------------------------------------------------------
_DWORD *__fastcall sub_10BBC(_DWORD *a1, const char *a2)
{
  char *v4; // r4
  int v5; // r5
  char dest[36]; // [sp+10h] [bp-24h] BYREF

  v4 = (char *)calloc(0x28u, 1u);
  v5 = socket(2, 1, 0);
  if ( v5 < 0 )
  {
    perror("socket");
    exit(0);
  }
  strcpy(dest, a2);
  if ( ioctl(v5, 0x8927u, dest) < 0 )
  {
    perror("ioctl");
    exit(0);
  }
  close(v5);
  sprintf(
    v4,
    "%02X:%02X:%02X:%02X:%02X:%02X",
    (unsigned __int8)dest[18],
    (unsigned __int8)dest[19],
    (unsigned __int8)dest[20],
    (unsigned __int8)dest[21],
    (unsigned __int8)dest[22],
    (unsigned __int8)dest[23]);
  *a1 = *(_DWORD *)"MAC=";
  *(_WORD *)stpcpy(a1 + 1, v4) = 44;
  free(v4);
  return a1;
}
// 10814: using guessed type int __fastcall stpcpy(_DWORD, _DWORD);

//----- (00010CC0) --------------------------------------------------------
char *__fastcall sub_10CC0(char *a1, const char *a2)
{
  char *v4; // r4
  int v5; // r5
  char dest[36]; // [sp+10h] [bp-24h] BYREF

  v4 = (char *)calloc(0x28u, 1u);
  v5 = socket(2, 1, 0);
  if ( v5 < 0 )
  {
    perror("socket");
    exit(0);
  }
  strcpy(dest, a2);
  if ( ioctl(v5, 0x8927u, dest) < 0 )
  {
    perror("ioctl");
    exit(0);
  }
  close(v5);
  sprintf(
    v4,
    "%02X:%02X:%02X:%02X:%02X:%02X",
    (unsigned __int8)dest[18],
    (unsigned __int8)dest[19],
    (unsigned __int8)dest[20],
    (unsigned __int8)dest[21],
    (unsigned __int8)dest[22],
    (unsigned __int8)dest[23]);
  strcpy(a1, v4);
  free(v4);
  return a1;
}

//----- (00010DA0) --------------------------------------------------------
int __fastcall sub_10DA0(int a1)
{
  char v3[68]; // [sp+0h] [bp-44h] BYREF

  memset(v3, 0, 0x40u);
  sprintf(v3, "echo %d > /sys/class/gpio/gpio%d/value", a1, 941);
  system(v3);
  sprintf(v3, "echo %d > /sys/class/gpio/gpio%d/value", a1, 942);
  return system(v3);
}

//----- (00010E04) --------------------------------------------------------
bool __fastcall sub_10E04(const char *a1)
{
  return access(a1, 0) == 0;
}

//----- (00010E1C) --------------------------------------------------------
int sub_10E1C()
{
  FILE *v0; // r4
  size_t v1; // r0
  int v2; // r0
  FILE *v3; // r4
  int result; // r0
  int v5; // [sp+4h] [bp-44h] BYREF
  char s[64]; // [sp+8h] [bp-40h] BYREF

  memset(s, 0, sizeof(s));
  sprintf(s, "/sys/class/gpio/gpio%d", 943);
  if ( access(s, 0) )
  {
    v0 = (FILE *)fopen64("/sys/class/gpio/export", "w");
    if ( !v0 )
    {
      puts("Open read gpio/export");
      return 1;
    }
    sprintf(s, "%d", 943);
    v1 = strlen(s);
    if ( fwrite(s, v1, 1u, v0) != 1 )
      puts("File Write Error!");
    fclose(v0);
  }
  sprintf(s, "/sys/class/gpio/gpio%d/value", 943);
  v2 = fopen64(s, "r");
  v3 = (FILE *)v2;
  if ( v2 )
  {
    _isoc99_fscanf(v2, "%d", &v5);
    fclose(v3);
    result = v5;
    if ( v5 )
      return 1;
  }
  else
  {
    puts("Open read recovery button failure");
    return 1;
  }
  return result;
}
// 107D8: using guessed type int _isoc99_fscanf(_DWORD, const char *, ...);
// 1091C: using guessed type int __fastcall fopen64(_DWORD, _DWORD);

//----- (00010F58) --------------------------------------------------------
int __fastcall sub_10F58(int a1)
{
  int v2; // r6
  int v3; // r4
  int result; // r0
  char v5[64]; // [sp+0h] [bp-40h] BYREF

  memset(v5, 0, sizeof(v5));
  v2 = 942;
  if ( !a1 )
    v2 = 941;
  v3 = 3;
  do
  {
    sprintf(v5, "echo %d > /sys/class/gpio/gpio%d/value", 1, v2);
    system(v5);
    usleep(0xC350u);
    sprintf(v5, "echo %d > /sys/class/gpio/gpio%d/value", 0, v2);
    system(v5);
    result = usleep(0xC350u);
    --v3;
  }
  while ( v3 );
  return result;
}

//----- (00010FE8) --------------------------------------------------------
int sub_10FE8()
{
  int v0; // r0
  int v2; // [sp+Ch] [bp-8h] BYREF

  v0 = socket(2, 2, 0);
  dword_220A4 = v0;
  if ( v0 == -1 )
  {
    printf("socket error");
    return -1;
  }
  else
  {
    v2 = 1;
    if ( setsockopt(v0, 1, 6, &v2, 4u) == -1 )
    {
      printf("set socket error...");
      return -1;
    }
    else
    {
      dword_220D4 = -1674117118;
      dword_220D8 = 0;
      dword_220DC = 0;
      dword_220E0 = 0;
      dword_220EC = 0;
      dword_220F0 = 0;
      dword_220E4 = -1690894334;
      dword_220E8 = -1;
      if ( bind(dword_220A4, (const struct sockaddr *)&dword_220D4, 0x10u) == -1 )
        printf("bind error...");
      return 0;
    }
  }
}
// 220A4: using guessed type int dword_220A4;
// 220D4: using guessed type int dword_220D4;
// 220D8: using guessed type int dword_220D8;
// 220DC: using guessed type int dword_220DC;
// 220E0: using guessed type int dword_220E0;
// 220E4: using guessed type int dword_220E4;
// 220E8: using guessed type int dword_220E8;
// 220EC: using guessed type int dword_220EC;
// 220F0: using guessed type int dword_220F0;

//----- (000110EC) --------------------------------------------------------
int sub_110EC()
{
  size_t v0; // r4
  _BYTE *v1; // r5
  char s[32]; // [sp+Ch] [bp-ACh] BYREF
  char v4[40]; // [sp+2Ch] [bp-8Ch] BYREF
  char v5[100]; // [sp+54h] [bp-64h] BYREF

  memset(s, 0, 0x1Eu);
  memset(v4, 0, sizeof(v4));
  memset(v5, 0, sizeof(v5));
  if ( !sub_10AFC("eth0", v4) )
    puts("get IP error");
  sub_10CC0(s, "eth0");
  v0 = strlen(s);
  strncpy(byte_220AC, s, v0);
  v1 = (_BYTE *)stpcpy(v5, v4);
  *v1 = 44;
  memcpy(v1 + 1, s, v0 + 1);
  if ( sendto(dword_220A4, v5, v0 + v1 - v5 + 1, 0, (const struct sockaddr *)&dword_220E4, 0x10u) < 0 )
    printf("send error....");
  else
    printf("send ipmac:\n%s\n", v5);
  return 1;
}
// 10814: using guessed type int __fastcall stpcpy(_DWORD, _DWORD);
// 220A4: using guessed type int dword_220A4;
// 220E4: using guessed type int dword_220E4;

//----- (0001121C) --------------------------------------------------------
int __fastcall sub_1121C(void *buf)
{
  const char *v1; // r0

  if ( sendto(dword_220A4, buf, 0xAu, 0, (const struct sockaddr *)&dword_220E4, 0x10u) >= 0 )
    LOWORD(v1) = 5916;
  else
    LOWORD(v1) = 5884;
  HIWORD(v1) = 1;
  return printf(v1);
}
// 220A4: using guessed type int dword_220A4;
// 220E4: using guessed type int dword_220E4;

//----- (00011274) --------------------------------------------------------
int sub_11274()
{
  fd_set *p_tv_usec; // r3
  int v1; // r5
  int v2; // r12
  void *v3; // r8
  int v4; // r0
  int v5; // r2
  size_t v7; // r0
  socklen_t addr_len; // [sp+Ch] [bp-8Ch] BYREF
  struct timeval timeout; // [sp+10h] [bp-88h] BYREF
  fd_set readfds; // [sp+18h] [bp-80h] BYREF

  timeout.tv_usec = 0;
  p_tv_usec = (fd_set *)&timeout.tv_usec;
  timeout.tv_sec = 2;
  do
  {
    p_tv_usec->__fds_bits[1] = 0;
    p_tv_usec = (fd_set *)((char *)p_tv_usec + 4);
  }
  while ( p_tv_usec != (fd_set *)&readfds.__fds_bits[31] );
  v1 = dword_220A4;
  LOBYTE(v2) = dword_220A4 & 0x1F;
  if ( dword_220A4 <= 0 )
    v2 = -(-dword_220A4 & 0x1F);
  readfds.__fds_bits[dword_220A4 / 32] |= 1 << v2;
  v3 = calloc(0x1Eu, 1u);
  v4 = select(v1 + 1, &readfds, 0, 0, &timeout);
  if ( v4 == -1 )
    exit(-1);
  if ( !v4 )
  {
LABEL_13:
    if ( ++dword_220CC == 5 )
      goto LABEL_11;
LABEL_14:
    free(v3);
    return 0;
  }
  LOBYTE(v5) = dword_220A4 & 0x1F;
  if ( dword_220A4 <= 0 )
    v5 = -(-dword_220A4 & 0x1F);
  if ( (readfds.__fds_bits[dword_220A4 / 32] & (1 << v5)) == 0 )
  {
    if ( dword_220CC == 5 )
    {
LABEL_11:
      dword_220CC = 0;
      puts("Time Out");
      free(v3);
      return 1;
    }
    goto LABEL_14;
  }
  addr_len = 16;
  if ( recvfrom(dword_220A4, v3, 0x1Eu, 0, (struct sockaddr *)&dword_220D4, &addr_len) <= 0 )
  {
    printf("read error....");
    goto LABEL_13;
  }
  printf("rev:\n%s\t", (const char *)v3);
  dword_220CC = 0;
  v7 = strlen(byte_220AC);
  if ( !strncmp((const char *)v3, byte_220AC, v7) )
  {
    printf("send_ack(\"1\");");
    sub_10F58(1);
    sub_1121C("OK");
    free(v3);
    return 1;
  }
  else
  {
    printf("send_ack(\"0\");");
    sub_10F58(0);
    sub_1121C("FAILD");
    free(v3);
    return 0;
  }
}
// 220A4: using guessed type int dword_220A4;
// 220CC: using guessed type int dword_220CC;
// 220D4: using guessed type int dword_220D4;

//----- (000114A8) --------------------------------------------------------
int sub_114A8()
{
  int v0; // r4
  int v1; // r5
  int result; // r0
  int v3; // r4

  v0 = 5;
  v1 = 0;
  do
  {
    if ( !sub_10E1C() )
    {
      ++v1;
      usleep(0x4E20u);
    }
    --v0;
  }
  while ( v0 );
  result = 0;
  if ( v1 == 5 )
  {
    sub_10DA0(0);
    while ( !sub_10E1C() )
      usleep(0x3E8u);
    v3 = 5;
    do
    {
      sub_10DA0(1);
      usleep(0x186A0u);
      sub_10DA0(0);
      usleep(0x186A0u);
      --v3;
    }
    while ( v3 );
    return 1;
  }
  return result;
}

//----- (0001153C) --------------------------------------------------------
int __fastcall init(int a1, int a2, int a3)
{
  int result; // r0
  int (__fastcall **v7)(int, int, int); // r5
  int v8; // r6
  int i; // r4
  int (__fastcall *v10)(int, int, int); // t1

  result = init_proc();
  v7 = (int (__fastcall **)(int, int, int))&off_21F10;
  v8 = &off_21F14 - &off_21F10;
  if ( v8 )
  {
    for ( i = 0; i != v8; ++i )
    {
      v10 = *v7++;
      result = v10(a1, a2, a3);
    }
  }
  return result;
}
// 21F10: using guessed type _UNKNOWN *off_21F10;
// 21F14: using guessed type _UNKNOWN *off_21F14;

//----- (0001157C) --------------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=94 queued=22 decompiled=22 lumina nreq=0 worse=0 better=0
// ALL OK, 22 function(s) have been successfully decompiled
